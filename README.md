# EuroMISS decode and data ferivication tools
Утилиты для декодирования сырых данных, вычитанных из электроники Евро-МИСС (ИФВЭ, Протвино).

  - **em-dump** - построчная интерпретация файла с данными (для отладки);
  - **em-parse** - разбор данных событий, вывод заголовков событий в формате [uDAQ](https://github.com/sergey-inform/uDAQ).

Позволяют обнаруживать слова, не соответствующие протоколу МИСС (ошибки).
  - ERR_DMA_OVERREAD — слово начала или конца события повторяется несколько раз в связи с особенностями работы контроллера DMA модулей EM-5, не ошибка.
  - ERR_DUP — повторяющееся слово (не относящееся к ERR_DMA_OVERREAD);
  - ERR_ZEROES — слово, состоящее из нулей;
  - ERR_ONES — слово, состоящее из единиц во всех разрядах;
  - ERR_UNKNOWN_WORD — неизвестный тип служебного слова МИСС;
  - ERR_PROTOCOL — нарушение последовательности служебных слов режима последовательного чтения электроники МИСС;
  - ERR_MISS_LEN — длина события не совпадает с счетчиком слов МИСС;
  - ERR_MISS_ADDR_ORDER — нарушен возрастающий порядок мест модулей в МИСС.
  
## Compilation
```sh
cd src
make
```
Можно использовать кросс-компиляцию для arm чтобы запускать программы на контроллере EM-5.
  
## em-dump
```
Usage: em-dump [OPTION...] [FILENAME]

Parse EuroMISS raw data file, print decoded data with errors to stdout.

 If no FILENAME, waits for data in stdin.

 Options:
  -e, --events               Print event data.
  -q, --quiet                Print only errors
```

### Пример вывода
```
000000  1a71 00be   PCHI  . 
000001  0683 0001  01 00  . 
000002  0300 0001  01 00  . 
000003  10f4 0001  01 00  . 
000004  41f8 0001  01 00  . 
...
0000a7  00a7 001f    END  . 
0000a8  082f 00fe      -  CNT_EM_EVENT 
0000a9  c1ff 00be   PCHI  . 
0000aa  1067 0001  01 00  . 
0000ab  0300 0001  01 00  . 
0000ac  0968 0001  01 00  . 
```
Столбцы:
  1. Номер слова в hex.
  1. Слово данных электроники МИСС.
  1. Слово адреса электроники МИСС.
  1. Состояние протокола МИСС (для слов данных — номер крейта и модуля, декодировнный в десятичный формат).
  1. Код ошибки.

### Варианты использования

`./em-dump 1.dat  | less` — просмотр всего содержимого файла. `/` для поиска фрагмента (например, по коду ошибки), `esc` для выхода.

`./em-dump 1.dat  -q` — вывод только слов с ошибками.
```
007a56  0304 0009  09 00  ERR_EM_DUPWORD 
011b6c  0308 0009  09 00  ERR_EM_DUPWORD 
0d587f  07fe 0000  00 00  ERR_MISS_ADDR_ORDER 
...
```

`./em-dump 1.dat  -eq` -- вывод ошибок и номеров/длин событий.
```
# Event 69     ts: 142539742   len:  503   OK 
# Event 70     ts: 142558443   len:  449   OK 
# Event 71     ts: 142575774   len:  297   OK 
# Event 72     ts: 142588634   len:  475   OK 
# Event 73     ts: 142605985   len:  441   OK 
007a56  0304 0009  09 00  ERR_EM_DUPWORD 
# Event 74     ts: 142624038   len:  613   CORRUPT 
```
Столбцы:
  1. Event номер события;
  1. ts: отметка времени;
  1. len: количество слов;
  1. статус ошибок (CORRUPT если событие содержит хотя бы одно слово со ошибкой).
  
## em-parse
Утилиту удобно использовать для получения статистики количества событий и с ошибками в файле (данные выводятся в stderr).
./em-parse 1.dat -o /dev/null
```
3249	 CNT_EM_EVENT 
16	 CNT_EM_EVENT_CORRUPTED 
--
WORDS_TOTAL              	 1714172 
ERR_EM_DUPWORD           	 15 
ERR_MISS_ADDR_ORDER      	 2
```
  - CNT_EM_EVENT — общее количество событий;
  - CNT_EM_EVENT_CORRUPTED — из них слов с ошибками;
  - WORDS_TOTAL — общее количество событий;
  - далее счета по кажтому встретившемуся типу ошибки.
